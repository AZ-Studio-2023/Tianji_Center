{% extends "dashboard/base.html" %}

{% block title %}修改密码{% endblock %}

{% block content %}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">修改密码</h2>
    
    <div class="bg-white rounded-lg shadow p-6">
        <form onsubmit="changePassword(event)" class="space-y-4">
            <div>
                <label class="block text-gray-700">新密码</label>
                <input type="password" name="new_password" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
                <label class="block text-gray-700">确认新密码</label>
                <input type="password" name="confirm_password" class="w-full border rounded px-3 py-2" required>
            </div>
            <div class="flex space-x-2">
                <input type="text" name="code" class="flex-1 border rounded px-3 py-2" placeholder="验证码" required>
                <button type="button" onclick="sendCode(this)" class="px-4 py-2 bg-gray-500 text-white rounded">
                    发送验证码
                </button>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                确认修改
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function sendCode(btn) {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = '发送中...';
    
    fetch('{{ url_for("auth.send_code") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: '{{ current_user.email }}' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            btn.disabled = false;
            btn.textContent = originalText;
        } else {
            let countdown = 60;
            const timer = setInterval(() => {
                btn.textContent = `${countdown}秒后重试`;
                countdown--;
                if (countdown < 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            }, 1000);
        }
    });
}

function changePassword(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    if (formData.get('new_password') !== formData.get('confirm_password')) {
        alert('两次输入的密码不一致');
        return;
    }
    
    fetch('{{ url_for("dashboard.change_password") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('密码修改成功');
            location.href = '{{ url_for("auth.login") }}';
        }
    });
}
</script>
{% endblock %} 